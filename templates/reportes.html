<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Reportes - Reservas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      .chart-card { min-height: 320px; }
    </style>
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <h1 class="mb-4">Reportes</h1>

      <div class="row mb-4">
        <div class="col-md-6">
          <div class="card chart-card">
            <div class="card-body">
              <h5 class="card-title">Ranking de canchas (más usadas)</h5>
              <canvas id="chart-ranking"></canvas>
              <div id="ranking-msg" class="mt-2 text-muted small"></div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card chart-card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="card-title mb-0">Uso mensual</h5>
                <div>
                  <label for="year-select" class="form-label small mb-0 me-2">Año</label>
                  <select id="year-select" class="form-select form-select-sm d-inline-block" style="width:100px"></select>
                </div>
              </div>
              <canvas id="chart-uso"></canvas>
              <div id="uso-msg" class="mt-2 text-muted small"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-12 text-end">
          <a href="/" class="btn btn-outline-secondary">Volver</a>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const API_RANKING = '/api/reportes/ranking_canchas';
      const API_USO = '/api/reportes/uso_mensual';

      let rankingChart = null;
      let usoChart = null;

      function createBarChart(ctx, labels, data) {
        if(rankingChart) rankingChart.destroy();
        rankingChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Reservas',
              data: data,
              backgroundColor: 'rgba(54, 162, 235, 0.7)'
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, precision:0 } }
          }
        });
      }

      function createLineChart(ctx, labels, data) {
        if(usoChart) usoChart.destroy();
        usoChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Reservas por mes',
              data: data,
              borderColor: 'rgba(255,99,132,0.8)',
              backgroundColor: 'rgba(255,99,132,0.2)',
              tension: 0.3,
              fill: true
            }]
          },
          options: { responsive: true, plugins: { legend: { display: false } } }
        });
      }

      async function fetchJson(url) {
        try {
          const res = await fetch(url);
          if(!res.ok) throw new Error('Fetch failed');
          return await res.json();
        } catch (e) {
          return null;
        }
      }

      async function loadRanking(){
        const data = await fetchJson(API_RANKING);
        const msg = document.getElementById('ranking-msg');
        const ctx = document.getElementById('chart-ranking').getContext('2d');
        if(!data || !data.ranking || data.ranking.length===0){
          msg.textContent = 'No hay datos de reservas para generar el ranking.';
          if(rankingChart) rankingChart.destroy();
          return;
        }
        msg.textContent = '';
        const labels = data.ranking.map(r => r.nombre + ' (ID:'+r.id_cancha+')');
        const values = data.ranking.map(r => r.reservas_count);
        createBarChart(ctx, labels, values);
      }

      async function loadUso(year){
        const q = year ? '?year=' + year : '';
        const data = await fetchJson(API_USO + q);
        const msg = document.getElementById('uso-msg');
        const ctx = document.getElementById('chart-uso').getContext('2d');
        if(!data || !data.uso_mensual || data.uso_mensual.length===0){
          msg.textContent = 'No hay datos de uso para el año seleccionado.';
          if(usoChart) usoChart.destroy();
          return;
        }
        msg.textContent = '';
        const labels = data.uso_mensual.map(r => r.month);
        const values = data.uso_mensual.map(r => r.count);
        createLineChart(ctx, labels, values);
      }

      function populateYearSelect(){
        const sel = document.getElementById('year-select');
        const current = new Date().getFullYear();
        // last 5 years
        for(let y = current; y >= current-4; y--){
          const opt = document.createElement('option'); opt.value = y; opt.text = y; sel.appendChild(opt);
        }
        sel.value = current;
        sel.addEventListener('change', () => loadUso(sel.value));
      }

      document.addEventListener('DOMContentLoaded', () => {
        populateYearSelect();
        loadRanking();
        loadUso(document.getElementById('year-select').value);
      });
    </script>
  </body>
</html>
