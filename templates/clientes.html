<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Clientes - ABM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <h1 class="mb-4">Registro de Clientes</h1>

      <div class="card mb-4">
        <div class="card-body">
          <form id="cliente-form">
            <input type="hidden" id="editingId" value="">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label">DNI</label>
                <input type="text" id="dni" class="form-control" required>
              </div>
              <div class="col-md-3">
                <label class="form-label">Nombre</label>
                <input type="text" id="nombre" class="form-control" required>
              </div>
              <div class="col-md-3">
                <label class="form-label">Apellido</label>
                <input type="text" id="apellido" class="form-control" required>
              </div>
              <div class="col-md-3">
                <label class="form-label">Teléfono</label>
                <input type="text" id="telefono" class="form-control">
              </div>

              <div class="col-md-6">
                <label class="form-label">Email</label>
                <input type="email" id="email" class="form-control">
              </div>
              <div class="col-md-2">
                <div class="form-check mt-3">
                  <input class="form-check-input" type="checkbox" id="activo" checked>
                  <label class="form-check-label">Activo</label>
                </div>
              </div>

              <div class="col-12">
                <button class="btn btn-primary" id="btn-submit">Registrar</button>
                <button type="button" class="btn btn-secondary" id="btn-reset">Limpiar</button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Clientes</h5>
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="show-inactivos">
            <label class="form-check-label" for="show-inactivos">Mostrar inactivos</label>
          </div>
          <div class="table-responsive">
            <table class="table table-striped" id="clientes-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>DNI</th>
                  <th>Nombre</th>
                  <th>Apellido</th>
                  <th>Teléfono</th>
                  <th>Email</th>
                  <th>Activo</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>

    <script>
      const API_BASE = '/api/clientes';

      async function loadClientes(){
        const showInactive = document.getElementById('show-inactivos') && document.getElementById('show-inactivos').checked;
        const url = API_BASE + (showInactive ? '?all=true' : '');
        const res = await fetch(url);
        const data = await res.json();
        const tbody = document.querySelector('#clientes-table tbody');
        tbody.innerHTML = '';
        data.forEach(c => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${c.id_cliente}</td>
            <td>${c.dni}</td>
            <td>${c.nombre}</td>
            <td>${c.apellido}</td>
            <td>${c.telefono || ''}</td>
            <td>${c.email || ''}</td>
            <td>${c.activo ? 'Sí' : 'No'}</td>
            <td>
              <button class="btn btn-sm btn-primary btn-edit" data-id="${c.id_cliente}">Modificar</button>
              <button class="btn btn-sm btn-danger btn-delete" data-id="${c.id_cliente}">Eliminar</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        document.querySelectorAll('.btn-edit').forEach(b => b.addEventListener('click', onEdit));
        document.querySelectorAll('.btn-delete').forEach(b => b.addEventListener('click', onDelete));
      }

      async function onDelete(e){
        const id = e.target.dataset.id;
        if(!confirm('¿Eliminar DEFINITIVAMENTE al cliente? Esta acción será irreversible.')) return;
        // DELETE por defecto realiza hard-delete (físico). Para soft-delete usar ?hard=false
        await fetch(`${API_BASE}/${id}`, { method: 'DELETE' });
        await loadClientes();
      }

      function fillForm(c){
        document.getElementById('editingId').value = c.id_cliente;
        document.getElementById('dni').value = c.dni;
        document.getElementById('nombre').value = c.nombre;
        document.getElementById('apellido').value = c.apellido;
        document.getElementById('telefono').value = c.telefono || '';
        document.getElementById('email').value = c.email || '';
        document.getElementById('activo').checked = c.activo === undefined ? true : !!c.activo;
        document.getElementById('btn-submit').textContent = 'Actualizar';
      }

      async function onEdit(e){
        const id = e.target.dataset.id;
        const res = await fetch(`${API_BASE}/${id}`);
        const c = await res.json();
        fillForm(c);
      }

      document.getElementById('cliente-form').addEventListener('submit', async function(ev){
        ev.preventDefault();
        const editingId = document.getElementById('editingId').value;
        const payload = {
          dni: document.getElementById('dni').value.trim(),
          nombre: document.getElementById('nombre').value.trim(),
          apellido: document.getElementById('apellido').value.trim(),
          telefono: document.getElementById('telefono').value.trim(),
          email: document.getElementById('email').value.trim() || null,
          activo: document.getElementById('activo').checked
        };

        let res;
        if(editingId){
          res = await fetch(`${API_BASE}/${editingId}`, {
            method: 'PUT',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
        } else {
          res = await fetch(`${API_BASE}`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
        }

        if(res.ok){
          resetForm();
          loadClientes();
        } else {
          const err = await res.json();
          alert(err.error || 'Error en la operación');
        }
      });

      function resetForm(){
        document.getElementById('editingId').value = '';
        document.getElementById('cliente-form').reset();
        document.getElementById('activo').checked = true;
        document.getElementById('btn-submit').textContent = 'Registrar';
      }

      document.getElementById('btn-reset').addEventListener('click', resetForm);

      // Inicializar
  document.getElementById('show-inactivos').addEventListener('change', loadClientes);
  loadClientes();
    </script>

  </body>
</html>
