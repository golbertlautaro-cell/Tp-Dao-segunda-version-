{% extends 'base.html' %}

{% block title %}Canchas - ABM{% endblock %}

{% block content %}
  <div class="py-4">
    <h1 class="mb-4">ABM de Canchas</h1>

    <div class="card mb-4">
      <div class="card-body">
        <form id="cancha-form">
          <input type="hidden" id="editingId" value="">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Nombre</label>
              <input type="text" id="nombre" class="form-control" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Deporte</label>
              <select id="id_deporte" class="form-select"><option value="">Seleccione deporte...</option></select>
              <div id="deportes-warning" class="mt-2"></div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Superficie</label>
              <input type="text" id="superficie" class="form-control">
            </div>
            <div class="col-md-2">
              <label class="form-label">Precio por hora</label>
              <input type="number" step="0.01" id="precio_hora" class="form-control">
            </div>

            <div class="col-md-2">
              <div class="form-check mt-3">
                <input class="form-check-input" type="checkbox" id="iluminacion">
                <label class="form-check-label">Iluminación</label>
              </div>
            </div>

            <div class="col-md-2">
              <div class="form-check mt-3">
                <input class="form-check-input" type="checkbox" id="activa" checked>
                <label class="form-check-label">Activa</label>
              </div>
            </div>

            <div class="col-12">
              <button class="btn btn-primary" id="btn-submit">Guardar</button>
              <button type="button" class="btn btn-secondary" id="btn-reset">Limpiar</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Canchas</h5>
        <div class="form-check form-switch mb-2">
          <input class="form-check-input" type="checkbox" id="show-inactivos">
          <label class="form-check-label" for="show-inactivos">Mostrar inactivos</label>
        </div>
        <div class="table-responsive">
          <table class="table table-striped" id="canchas-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Deporte</th>
                <th>Superficie</th>
                <th>Precio/h</th>
                <th>Iluminación</th>
                <th>Activa</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
  const API_BASE = '/api/canchas';
  const API_DEPORTES = '/api/deportes';

  let deportesList = [];

  async function loadCanchas(){
    const showInactive = document.getElementById('show-inactivos') && document.getElementById('show-inactivos').checked;
    const url = API_BASE + (showInactive ? '?all=true' : '');
    const res = await fetch(url);
    const data = await res.json();
    const tbody = document.querySelector('#canchas-table tbody');
    tbody.innerHTML = '';
    data.forEach(c => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${c.id_cancha}</td>
        <td>${c.nombre}</td>
        <td>${(c.deporte && c.deporte.nombre) ? c.deporte.nombre : (c.tipo_deporte || '')}</td>
        <td>${c.superficie || ''}</td>
        <td>${c.precio_hora || ''}</td>
        <td>${c.iluminacion ? 'Sí' : 'No'}</td>
        <td>${c.activa ? 'Sí' : 'No'}</td>
        <td>
          <button class="btn btn-sm btn-primary btn-edit" data-id="${c.id_cancha}">Modificar</button>
          <button class="btn btn-sm btn-danger btn-delete" data-id="${c.id_cancha}">Eliminar</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    document.querySelectorAll('.btn-edit').forEach(b => b.addEventListener('click', onEdit));
    document.querySelectorAll('.btn-delete').forEach(b => b.addEventListener('click', onDelete));
  }

  async function loadDeportes(){
    const res = await fetch(API_DEPORTES);
    if(!res.ok) return [];
    const data = await res.json();
    deportesList = data;
    const sel = document.getElementById('id_deporte');
    const warn = document.getElementById('deportes-warning');
    sel.innerHTML = '<option value="">Seleccione deporte...</option>';
    if(!data || data.length === 0){
      warn.innerHTML = '<div class="alert alert-warning p-2">No hay deportes definidos — vaya a <a href="/ui/deportes">ABM de deportes</a> para crear uno.</div>';
      const btn = document.getElementById('btn-submit'); if(btn) btn.disabled = true;
      return;
    } else {
      warn.innerHTML = '';
      const btn = document.getElementById('btn-submit'); if(btn) btn.disabled = false;
    }
    data.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d.id_deporte;
      opt.textContent = `${d.nombre} (${d.duracion_minutos} min)`;
      sel.appendChild(opt);
    });
  }

  async function onDelete(e){
    const id = e.target.dataset.id;
    if(!confirm('¿Eliminar DEFINITIVAMENTE la cancha? Esta acción será irreversible.')) return;
    await fetch(`${API_BASE}/${id}`, { method: 'DELETE' });
    await loadCanchas();
  }

  function fillForm(c){
    document.getElementById('editingId').value = c.id_cancha;
    document.getElementById('nombre').value = c.nombre;
    document.getElementById('id_deporte').value = c.id_deporte || '';
    document.getElementById('superficie').value = c.superficie || '';
    document.getElementById('precio_hora').value = c.precio_hora || '';
    document.getElementById('iluminacion').checked = !!c.iluminacion;
    document.getElementById('activa').checked = c.activa === undefined ? true : !!c.activa;
    document.getElementById('btn-submit').textContent = 'Actualizar';
  }

  async function onEdit(e){
    const id = e.target.dataset.id;
    const res = await fetch(`${API_BASE}/${id}`);
    const c = await res.json();
    fillForm(c);
  }

  document.getElementById('cancha-form').addEventListener('submit', async function(ev){
    ev.preventDefault();
    const editingId = document.getElementById('editingId').value;
    const payload = {
      nombre: document.getElementById('nombre').value.trim(),
      id_deporte: document.getElementById('id_deporte').value ? parseInt(document.getElementById('id_deporte').value) : null,
      superficie: document.getElementById('superficie').value.trim() || null,
      precio_hora: document.getElementById('precio_hora').value ? parseFloat(document.getElementById('precio_hora').value) : 0,
      iluminacion: document.getElementById('iluminacion').checked,
      activa: document.getElementById('activa').checked
    };

    let res;
    if(editingId){
      res = await fetch(`${API_BASE}/${editingId}`, {
        method: 'PUT',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
    } else {
      res = await fetch(`${API_BASE}`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
    }

    if(res.ok){
      resetForm();
      loadCanchas();
    } else {
      const err = await res.json();
      alert(err.error || 'Error en la operación');
    }
  });

  function resetForm(){
    document.getElementById('editingId').value = '';
    document.getElementById('cancha-form').reset();
    document.getElementById('btn-submit').textContent = 'Guardar';
  }

  document.getElementById('btn-reset').addEventListener('click', resetForm);

  // Inicializar
  document.getElementById('show-inactivos').addEventListener('change', loadCanchas);
  loadDeportes().then(loadCanchas);
</script>
{% endblock %}
