<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Reservar cancha</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <h1 class="mb-4">Reservar Cancha</h1>

      <div class="card mb-4">
        <div class="card-body">
          <form id="reserva-form">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Cliente</label>
                <select id="select-cliente" class="form-select" required>
                  <option value="">Seleccionar cliente...</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Cancha</label>
                <select id="select-cancha" class="form-select" required>
                  <option value="">Seleccionar cancha...</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Fecha</label>
                <input type="date" id="fecha" class="form-control" required>
              </div>

              <div class="col-md-3">
                <label class="form-label">Hora inicio</label>
                <select id="hora_inicio" class="form-select" required>
                  <option value="">Seleccionar hora...</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Hora fin</label>
                <input type="text" id="hora_fin" class="form-control" readonly placeholder="--:--">
              </div>

              <div class="col-md-3">
                <div class="form-check mt-4">
                  <input class="form-check-input" type="checkbox" id="usa_iluminacion">
                  <label class="form-check-label">Usar iluminación</label>
                </div>
              </div>

              <div class="col-12">
                <h5>Servicios adicionales</h5>
                <div id="servicios-list" class="d-flex gap-3 flex-wrap">
                  <!-- Checkboxes añadidos por JS -->
                </div>
              </div>

              <div class="col-12 mt-3">
                <button class="btn btn-primary" id="btn-submit">Reservar</button>
                <button type="button" class="btn btn-secondary" id="btn-reset">Limpiar</button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <div id="result" class="mt-3"></div>
      <div id="reservas-existentes" class="mt-4">
        <h5>Reservas ya hechas</h5>
        <div id="reservas-list" class="list-group"></div>
        <h6 class="mt-3">Slots disponibles (por horario definido)</h6>
        <div id="slots-list" class="d-flex gap-2 flex-wrap"></div>
      </div>
    </div>

    <script>
      const API_CLIENTES = '/api/clientes';
      const API_CANCHAS = '/api/canchas';
      const API_SERVICIOS = '/api/servicios'; // puede no existir si no hay endpoint; manejamos 404
      const API_RESERVAS = '/api/reservas';

      async function fetchJson(url){
        try{
          const res = await fetch(url);
          if(!res.ok) return null;
          return await res.json();
        }catch(e){
          return null;
        }
      }

      async function loadSelects(){
        const clientes = await fetchJson(API_CLIENTES) || [];
        const canchas = await fetchJson(API_CANCHAS) || [];
        const servicios = await fetchJson(API_SERVICIOS) || [];

        const selCliente = document.getElementById('select-cliente');
        clientes.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.id_cliente;
          opt.textContent = `${c.nombre} ${c.apellido} (${c.dni})`;
          selCliente.appendChild(opt);
        });

        const selCancha = document.getElementById('select-cancha');
        canchas.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.id_cancha;
          opt.textContent = `${c.nombre} — ${c.tipo_deporte || ''} — $${c.precio_hora}`;
          selCancha.appendChild(opt);
        });

        // cuando cambia la cancha o la fecha, recargar reservas y slots
        document.getElementById('select-cancha').addEventListener('change', onCanchaFechaChange);
        document.getElementById('fecha').addEventListener('change', onCanchaFechaChange);
        // poblar select de horas de inicio (09:00 - 22:00)
        const selHora = document.getElementById('hora_inicio');
        for(let h=9; h<=22; h++){
          const hh = String(h).padStart(2,'0') + ':00';
          const opt = document.createElement('option');
          opt.value = hh;
          opt.textContent = hh;
          selHora.appendChild(opt);
        }
        // cuando cambia la hora de inicio, actualizar hora_fin automáticamente
        selHora.addEventListener('change', () => {
          const v = selHora.value;
          if(!v){ document.getElementById('hora_fin').value = '' ; return; }
          const h = parseInt(v.split(':')[0],10);
          const end = String(h+1).padStart(2,'0') + ':00';
          document.getElementById('hora_fin').value = end;
        });

        const serviciosDiv = document.getElementById('servicios-list');
        if(servicios.length === 0){
          serviciosDiv.innerHTML = '<small class="text-muted">No hay servicios adicionales disponibles</small>';
        } else {
          servicios.forEach(s => {
            const id = `serv-${s.id_servicio}`;
            const wrapper = document.createElement('div');
            wrapper.className = 'form-check';
            wrapper.innerHTML = `
              <input class="form-check-input" type="checkbox" value="${s.id_servicio}" id="${id}">
              <label class="form-check-label" for="${id}">${s.nombre} ($${s.precio_adicional})</label>
            `;
            serviciosDiv.appendChild(wrapper);
          });
        }
      }

      document.getElementById('reserva-form').addEventListener('submit', async function(ev){
        ev.preventDefault();
        const payload = {
          id_cliente: parseInt(document.getElementById('select-cliente').value),
          id_cancha: parseInt(document.getElementById('select-cancha').value),
          fecha_reserva: document.getElementById('fecha').value,
          hora_inicio: document.getElementById('hora_inicio').value,
          hora_fin: document.getElementById('hora_fin').value,
          usa_iluminacion: document.getElementById('usa_iluminacion').checked,
          servicios_adicionales: []
        };

        document.querySelectorAll('#servicios-list input[type=checkbox]:checked').forEach(cb => {
          payload.servicios_adicionales.push(parseInt(cb.value));
        });

        // antes de enviar, comprobar disponibilidad vía endpoint check
        const checkUrl = `/api/reservas/check?id_cancha=${payload.id_cancha}&fecha_reserva=${payload.fecha_reserva}&hora_inicio=${payload.hora_inicio}&hora_fin=${payload.hora_fin}`;
        const check = await fetchJson(checkUrl);
        const resultDiv = document.getElementById('result');
        if(!check || !check.available){
          resultDiv.innerHTML = `<div class="alert alert-warning">No disponible: ${check && check.reason ? check.reason : 'ocupado o error en la validación'}</div>`;
          return;
        }

        const res = await fetch(API_RESERVAS, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        
        if(res.status === 201){
          const data = await res.json();
          resultDiv.innerHTML = `<div class="alert alert-success">Reserva creada. ID: ${data.id_reserva} — Precio total: $${data.precio_total}</div>`;
          this.reset();
          // limpiar hora_fin y refrescar lista de reservas/slots
          document.getElementById('hora_fin').value = '';
          onCanchaFechaChange();
        } else if(res.status === 409){
          const err = await res.json();
          resultDiv.innerHTML = `<div class="alert alert-warning">Conflicto: ${err.error}</div>`;
        } else {
          const err = await res.json();
          resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${err.error || 'Error al crear la reserva'}</div>`;
        }
      });

      document.getElementById('btn-reset').addEventListener('click', function(){
        document.getElementById('reserva-form').reset();
        document.getElementById('result').innerHTML = '';
      });

      // Inicializar selects al cargar la página
      loadSelects();

      // --- Nuevas funciones para mostrar reservas y slots ---
      async function onCanchaFechaChange(){
        const idCancha = document.getElementById('select-cancha').value;
        const fecha = document.getElementById('fecha').value;
        const listDiv = document.getElementById('reservas-list');
        const slotsDiv = document.getElementById('slots-list');
        listDiv.innerHTML = '';
        slotsDiv.innerHTML = '';
        if(!idCancha || !fecha) return;

        // obtener reservas existentes
        const reservas = await fetchJson(`${API_RESERVAS}?id_cancha=${idCancha}&fecha_reserva=${fecha}`) || [];

        if(reservas.length === 0){
          listDiv.innerHTML = '<div class="list-group-item text-muted">No hay reservas para la fecha seleccionada</div>';
        } else {
          reservas.forEach(r => {
            const item = document.createElement('div');
            item.className = 'list-group-item';
            item.textContent = `${r.hora_inicio} - ${r.hora_fin} — ${r.cliente_nombre || ''} ${r.cliente_apellido || ''} (ID: ${r.id_reserva})`;
            listDiv.appendChild(item);
          });
        }

        // obtener horarios definidos para la cancha y marcar slots por hora
        const horarios = await fetchJson(`${API_CANCHAS}/${idCancha}/horarios?fecha=${fecha}`) || [];
        // construimos slots por cada horario disponible
        if(horarios.length === 0){
          // si no hay horarios definidos, usar rango por defecto 09:00-23:00
          for(let hh = 9; hh < 23; hh++){
            addSlot(hh, reservas, slotsDiv);
          }
        } else {
          for(const h of horarios){
            // solo considerar horarios que están disponibles para la fecha
            if(h.disponible_para_fecha === false) continue;
            // parsear hora y minuto
            const partsStart = h.hora_inicio.split(':');
            const partsEnd = h.hora_fin.split(':');
            let startH = parseInt(partsStart[0],10);
            const startM = parseInt(partsStart[1] || '0',10);
            const endH = parseInt(partsEnd[0],10);
            // si el inicio tiene minutos >0, redondear hacia arriba al siguiente entero
            if(startM > 0) startH = startH + 1;
            // clamp al rango 9..23
            startH = Math.max(9, startH);
            const clampEnd = Math.min(23, endH);
            for(let hh = startH; hh < clampEnd; hh++){
              addSlot(hh, reservas, slotsDiv);
            }
          }
        }
      }

      function addSlot(hh, reservas, slotsDiv){
        const slotLabel = `${String(hh).padStart(2,'0')}:00 - ${String(hh+1).padStart(2,'0')}:00`;
        const slotEl = document.createElement('button');
        slotEl.type = 'button';
        slotEl.className = 'btn btn-sm btn-outline-success';
        slotEl.textContent = slotLabel;
        // si existe reserva que cubra este slot, marcar como ocupado
        const ocupado = reservas.some(r => {
          const ri = parseInt(r.hora_inicio.split(':')[0],10);
          const rf = parseInt(r.hora_fin.split(':')[0],10);
          return (hh >= ri && hh < rf);
        });
        if(ocupado){
          slotEl.className = 'btn btn-sm btn-outline-danger disabled';
        } else {
          // al hacer click en un slot lo seleccionamos en los inputs
          slotEl.addEventListener('click', ()=>{
            document.getElementById('hora_inicio').value = `${String(hh).padStart(2,'0')}:00`;
            document.getElementById('hora_fin').value = `${String(hh+1).padStart(2,'0')}:00`;
          });
        }
        slotsDiv.appendChild(slotEl);
      }
    </script>
  </body>
</html>
